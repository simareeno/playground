define(["packages/event-bus","packages/4game-api-client","global/config","packages/jquery"],function(e,n,t,i){var r,o,u;if(function(e){function n(e,n){return h.call(e,n)}function t(e,n){var t,i,r,o,u,c,a,f,s,l,d,p=n&&n.split("/"),m=w.map,b=m&&m["*"]||{};if(e&&"."===e.charAt(0))if(n){for(p=p.slice(0,p.length-1),e=e.split("/"),u=e.length-1,w.nodeIdCompat&&k.test(e[u])&&(e[u]=e[u].replace(k,"")),e=p.concat(e),s=0;s<e.length;s+=1)if(d=e[s],"."===d)e.splice(s,1),s-=1;else if(".."===d){if(1===s&&(".."===e[2]||".."===e[0]))break;s>0&&(e.splice(s-1,2),s-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((p||b)&&m){for(t=e.split("/"),s=t.length;s>0;s-=1){if(i=t.slice(0,s).join("/"),p)for(l=p.length;l>0;l-=1)if(r=m[p.slice(0,l).join("/")],r&&(r=r[i])){o=r,c=s;break}if(o)break;!a&&b&&b[i]&&(a=b[i],f=s)}!o&&a&&(o=a,c=f),o&&(t.splice(0,c,o),e=t.join("/"))}return e}function i(n,t){return function(){return p.apply(e,_.call(arguments,0).concat([n,t]))}}function c(e){return function(n){return t(n,e)}}function a(e){return function(n){v[e]=n}}function f(t){if(n(g,t)){var i=g[t];delete g[t],y[t]=!0,d.apply(e,i)}if(!n(v,t)&&!n(y,t))throw new Error("No "+t);return v[t]}function s(e){var n,t=e?e.indexOf("!"):-1;return t>-1&&(n=e.substring(0,t),e=e.substring(t+1,e.length)),[n,e]}function l(e){return function(){return w&&w.config&&w.config[e]||{}}}var d,p,m,b,v={},g={},w={},y={},h=Object.prototype.hasOwnProperty,_=[].slice,k=/\.js$/;m=function(e,n){var i,r=s(e),o=r[0];return e=r[1],o&&(o=t(o,n),i=f(o)),o?e=i&&i.normalize?i.normalize(e,c(n)):t(e,n):(e=t(e,n),r=s(e),o=r[0],e=r[1],o&&(i=f(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:i}},b={require:function(e){return i(e)},exports:function(e){var n=v[e];return"undefined"!=typeof n?n:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:l(e)}}},d=function(t,r,o,u){var c,s,l,d,p,w,h=[],_=typeof o;if(u=u||t,"undefined"===_||"function"===_){for(r=!r.length&&o.length?["require","exports","module"]:r,p=0;p<r.length;p+=1)if(d=m(r[p],u),s=d.f,"require"===s)h[p]=b.require(t);else if("exports"===s)h[p]=b.exports(t),w=!0;else if("module"===s)c=h[p]=b.module(t);else if(n(v,s)||n(g,s)||n(y,s))h[p]=f(s);else{if(!d.p)throw new Error(t+" missing "+s);d.p.load(d.n,i(u,!0),a(s),{}),h[p]=v[s]}l=o?o.apply(v[t],h):void 0,t&&(c&&c.exports!==e&&c.exports!==v[t]?v[t]=c.exports:l===e&&w||(v[t]=l))}else t&&(v[t]=o)},r=o=p=function(n,t,i,r,o){if("string"==typeof n)return b[n]?b[n](t):f(m(n,t).f);if(!n.splice){if(w=n,w.deps&&p(w.deps,w.callback),!t)return;t.splice?(n=t,t=i,i=null):n=e}return t=t||function(){},"function"==typeof i&&(i=r,r=o),r?d(e,n,t,i):setTimeout(function(){d(e,n,t,i)},4),p},p.config=function(e){return p(e)},r._defined=v,u=function(e,t,i){t.splice||(i=t,t=[]),n(v,e)||n(g,e)||(g[e]=[e,t,i])},u.amd={jQuery:!0}}(),u("node_modules/almond/almond",function(){}),"object"==typeof module&&"function"!=typeof u)var u=function(e){module.exports=e(o,exports,module)};if(u("lib/ns-backend",["require","exports","module","event-bus","4game-api-client","jquery"],function(e){function n(e){return e=s.extend({attempts:1},e),c&&"pending"===c.state()&&c.reject(),c=s.Deferred(),f.getCredentials().then(function(n){var i="ns-"+n.userId+"-mark_as_read",r=JSON.parse(window.localStorage.getItem(i)||"[]"),o=s.Deferred();r.length?o=s.when.apply(null,r.map(function(e){var n=s.Deferred();return u(e,i).then(n.resolve,n.resolve),n})):o.resolve();for(var a=0;a<e.attempts;a++)o=o.then(function(){function n(){e.timeout&&e.attempts-1!=a?setTimeout(i.resolve,e.timeout):i.resolve()}if("pending"===c.state()){var i=s.Deferred();return t().then(n,n),i}});return o.then(function(){c&&c.resolve()})})}function t(){return f.revault.get("notifications").then(function(e){return l.publish("received",e),e},function(e){404===e.status&&l.publish("received",{})})}function i(e){return f.getCredentials().then(function(n){var t="ns-"+n.userId+"-mark_as_read";return r(t,e.id),u(e.id,t).then(function(){l.publish("markedAsRead",e)})})}function r(e,n){var t=JSON.parse(window.localStorage.getItem(e)||"[]");return t.indexOf(n)<0&&(t.push(n),window.localStorage.setItem(e,JSON.stringify(t))),t}function o(e,n){var t=JSON.parse(window.localStorage.getItem(e)||"[]");return t=t.filter(function(e){return e!==n}),window.localStorage.setItem(e,JSON.stringify(t)),t}function u(e,n){return f.revault.delete("notifications/"+e).then(function(){o(n,e)},function(t){t.status<500&&o(n,e)})}var c,a=e("event-bus"),f=e("4game-api-client"),s=e("jquery"),l=a.channel("notifications");return l.subscribe("receive",n),l.subscribe("markAsRead",i),{receive:n,markAsRead:i}}),"object"==typeof module&&"function"!=typeof u)var u=function(e){module.exports=e(o,exports,module)};return u("lib/ns-client",["require","exports","module","./ns-backend","event-bus","config"],function(e){function n(e,n){function t(){var c=Date.now(),a=c-o;a>=n?e.apply(null,r):u.id=i(t)}var i="undefined"!=typeof window&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozCancelRequestAnimationFrame&&window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame);if(!i)return setTimeout.apply(null,arguments);var r=Array.prototype.slice.call(arguments,2),o=Date.now(),u={};return u.id=i(t),u}function t(e){var n="undefined"!=typeof window&&(window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame);n?n(e.id):clearTimeout(e)}function i(e,n,t){var i,o,u=Date.now(),c=Object.keys(n||{});for(i=c.length-1;i>=0;i--)o=n[c[i]],o.expireTime&&o.expireTime<u?f(o):o.startDate&&o.startDate>u||r(e,o)&&t(o)}function r(e,n){return e?o(e.type,n)?u(e.tags,n)?!0:!1:!1:!0}function o(e,n){return c(e,n.type)}function u(e,n){return c(e,n.tags)}function c(e,n){return e?a([].concat(n))(e):!0}function a(e){return e?Array.isArray(e)?function(n){return e.indexOf("all")>=0?!0:Array.isArray(n)?!n.filter(function(n){return-1==e.indexOf(n)}).length:e.indexOf(n)>=0}:function(n){return n===e}:function(){return!1}}function f(e){p.publish("markAsRead",e)}function s(e){return e?+new Date:"notificationsDefaultChannel"}var l=(e("./ns-backend"),e("event-bus")),d=1e3*e("config").notificationPollingTimeout,p=l.channel("notifications"),m=function(){function e(e){i&&t(i),p.publish("receive",e||{})}var i,r;return function(){return r?(p.publish("received",r),void 0):(r={},p.subscribe("received",function(o){r=o,i&&t(i),i=n(e,d,null)}),l.on("@user","interaction",function(n){"navigation"===n&&e({attempts:2,timeout:1e4})}),e(),void 0)}}();return{markAsRead:f,filter:function(e){var n=l.channel(s(e)),t=function(e){return function(t){n.publish({topic:e,data:t})}};return p.subscribe({topic:"*",callback:function(n,r){i(e,n,t(r.topic))}}),m(),n},subscribe:function(e,n,t){"function"==typeof e&&(t=n,n=e,e="received");var r={},o=function(e){var o={};for(var u in e)r[u]||(r[u]=!0,o[u]=e[u]);i(t,o,n)},u=p.subscribe({topic:e,callback:o});return n.__subscriber=u,n.__allreadyReceivedNotifications=r,m(),u},unsubscribe:function(e,n){if("function"==typeof e)n=e,e="received";else if(e instanceof l.SubscriptionDefinition)return e.__allreadyReceivedNotifications=null,e.__subscriber=null,e.unsubscribe(),void 0;"function"==typeof n&&n.__subscriber&&n.__subscriber instanceof l.SubscriptionDefinition&&(n.__subscriber.unsubscribe(),n.__allreadyReceivedNotifications=null,n.__subscriber=null)}}}),u("event-bus",function(){return e}),u("4game-api-client",function(){return n}),u("config",function(){return t}),u("jquery",function(){return i}),o("lib/ns-client")});