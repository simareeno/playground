define(["exports","packages/react","packages/jquery","packages/4game-api-client","global/config","streams/events","i18n_t","i18n!User","i18n!Interface","components/form/simple","components/jade-template","components/mixins/captcha","components/auth/login/sections","components/social-avatar"],function(exports,t,e,a,o,i,s,n,r,l,c,m,u,d){"use strict";function h(t){return t&&t.__esModule?t:{"default":t}}function p(t,e){b["default"].log("@user",t,E["default"].extend({host:window.location.hostname},e))}function g(t){var e=window.location.hostname.split(".").slice(1),a={expires:new Date(t.getExpiresAt()),domain:e.join("."),path:"/"};E["default"].cookie(C["default"].cookieName,t.getAccessToken(),a),E["default"].cookie(C["default"].cookieName+"-p",t.getExpiresIn(),a)}Object.defineProperty(exports,"__esModule",{value:!0});var f=h(t),E=h(e),_=h(a),C=h(o),b=h(i),P=h(s),A=(h(n),h(r),h(l)),S=(h(c),h(m)),I=h(u),R=h(d),L={LOGIN:"AuthForm[loginOrEmail]",PASSWORD:"AuthForm[password]",CAPTCHA:"AuthForm[captcha]",REMEMBER_ME:"AuthForm[rememberMe]"},w={login:L.LOGIN,password:L.PASSWORD,captchaValue:L.CAPTCHA,rememberMe:L.REMEMBER_ME},N=["rememberMe"],F={LOGIN:"login-popup",SOCIAL:"social-link-popup"},T={WRONG_CREDENTIALS:401,BLOCKED_USER:403,WRONG_CAPTCHA:412,CAPTCHA_REQUIRED:429};exports["default"]=f["default"].createClass({displayName:"LoginForm",mixins:[S["default"],I["default"]],statics:{formTypes:F,setCookieByAuthTicket:g},getInitialState:function(){return{formType:this.props.formType||F.LOGIN,login:this.props.foundContact||"",loginError:"",password:"",passwordError:"",rememberMe:!0,blocked:!1,wrongPassword:!1,captchaId:null,captchaValue:"",wrongCaptcha:!1,progress:!1,isValid:!1}},getDefaultProps:function(){return{focused:!0}},componentWillMount:function(){this.attempts={},this.timer=null,this.timeout=20},componentDidMount:function(){_["default"].send("options","tokens").then(function(t){"0"===t.getResponseHeader("X-Rate-Limit-Remaining")&&this.setState({captchaId:this.getCaptcha().id})}.bind(this))},componentWillUnmount:function(){this.stopTimer(),this.attempts=null},render:function(){switch(this.state.formType){case F.LOGIN:return this.getPopupLoginForm();case F.SOCIAL:return this.getSocialLoginForm()}},getSocialLoginForm:function(){return f["default"].createElement(A["default"],{onSubmit:this.simpleAuth,onChange:this.onChange,onErrors:this.onErrors,validateSubmit:"true"},f["default"].createElement("div",{className:"bRegistrationPage__eContainer bRegistrationPage__eContainer__mInnerIndent"},f["default"].createElement("div",{className:"bRegistrationPage__eColumn bRegistrationPage__eColumn__mAutoWidth bRegistrationPage__eColumn__mShiftLeft"},f["default"].createElement(R["default"],{contactType:this.props.contactType,connectUserId:this.props.connectUserId,accessToken:this.props.accessToken})),f["default"].createElement("div",{className:"bRegistrationPage__eColumn bRegistrationPage__eColumn__mFixedFormWidth mSocialPopup"},f["default"].createElement("div",{className:"bExternalPageFormItem mFirst"},this.getLoginSection({placeholder:(0,P["default"])("User","4GameEmailOrLoginPlaceholder")})),f["default"].createElement("div",{className:"bExternalPageFormItem"},this.getPasswordSection({placeholder:(0,P["default"])("User","4GamePasswordPlaceholder")})),f["default"].createElement("div",{className:"bExternalPageFormItem",onClick:this.reloadCaptcha},this.getCaptchaSection({id:"jsAuthForm__eCaptcha"})),f["default"].createElement("div",{className:"bExternalPageFormItem"},this.getButtonSection({title:(0,P["default"])("Interface","LinkAndEnter"),dataAttributes:{ft:"ft_submitButtonLinkSocial"}})),f["default"].createElement("div",{className:"bExternalPageFormItem mLast"},this.getRememberMeSection({id:"jsAuthPopupWidgetLayout__eRecoveryPassRememberMe"},{target:"_blank"},"bAuthPopupWidgetLayout__eAuthProps")))))},getPopupLoginForm:function(){return f["default"].createElement(A["default"],{onSubmit:this.simpleAuth,onChange:this.onChange,onErrors:this.onErrors,validateSubmit:"true"},f["default"].createElement("div",{className:"bExternalPageFormItem"},this.getLoginSection({id:"AuthFormLogin"},{id:"AuthForm_loginOrEmail"})),f["default"].createElement("div",{className:"bExternalPageFormItem"},this.getPasswordSection({id:"AuthFormPassword"},{id:"AuthForm_password"})),f["default"].createElement("div",{className:"bExternalPageFormItem",onClick:this.reloadCaptcha},this.getCaptchaSection(null,{id:"AuthForm_captcha"})),f["default"].createElement("div",{className:"bExternalPageFormItem"},this.getButtonSection({id:"jsLoginPopupWidget__SignIn"})),f["default"].createElement("div",{className:"bExternalPageFormItem mLast"},this.getRememberMeSection({id:"jsLoginPopupWidget__RememberMe"},null,"bAuthPopupWidgetLayout__eAuthProps")))},simpleAuth:function(t){t.preventDefault();var e;this.attempts[this.state.login]||(this.attempts[this.state.login]=0),e=++this.attempts[this.state.login];var a={login:this.state.login,attempt:e};p("authorization-started",a),this.startTimer(a),this.setState({progress:!0,loginError:"",passwordError:""}),_["default"].user.login({login:this.state.login,password:this.state.password,captcha:this.getCaptchaValue()},this.state.rememberMe).then(function(t){g(t),p("authorization-succeeded",a),this.stopTimer(),"function"==typeof this.props.onComplete&&this.props.onComplete(t)}.bind(this),function(t,e,o){var i={captchaId:null,captchaValue:"",wrongCaptcha:!1,progress:!1,blocked:!1};switch(p("authorization-failed",E["default"].extend({status:t&&t.status,type:e,error:t&&t.responseJSON&&t.responseJSON.error},a)),this.stopTimer(),t.status){case T.WRONG_CREDENTIALS:i.wrongPassword=!0;break;case T.BLOCKED_USER:i.blocked=!0;break;case T.CAPTCHA_REQUIRED:i.captchaId=this.getCaptcha().id,i.wrongPassword=!1;break;case T.WRONG_CAPTCHA:i.captchaId=this.getCaptcha().id,i.wrongCaptcha=!0}this.isMounted()&&this.setState(i)}.bind(this))},onChange:function(t,e){this.setState(A["default"].toStateDiff(t,w,N,null,{isValid:e}))},onErrors:function(t){this.setState(A["default"].toStateDiff(t,w,null,function(t){return t+"Error"},{loginError:"",passwordError:""}))},startTimer:function(t){this.timer&&this.stopTimer(),this.timer=setTimeout(function(){p("authorization-timeouted",E["default"].extend({timeout:this.timeout+"sec"},t))}.bind(this),1e3*this.timeout)},stopTimer:function(){this.timer&&clearTimeout(this.timer),this.timer=null}})});
//# sourceMappingURL=login.js.map
