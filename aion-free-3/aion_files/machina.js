define(["exports","module","block!purchase/lib/lodash"],function(exports,t,e){"use strict";function i(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},namespace:S.makeFsmNamespace(),useSafeEmit:!1,hierarchy:{},pendingDelegations:{}}}function n(){return{inputQueue:[],targetReplayState:"",state:void 0,priorState:void 0,priorAction:"",currentAction:"",currentActionArgs:void 0,inExitHandler:!1}}function s(t,e){for(var i=[],n=e||0;n<t.length;n++)i[n]=t[n];return i}function a(t){if(t){var e={};return"object"==typeof t?t.factory?e=t:e.factory=function(){return t}:"function"==typeof t&&(e.factory=t),e.instance=e.factory(),e}}function r(t,e){return e.on("*",function(e,i){switch(e){case"nohandler":i.ticket||i.delegated||i.namespace===t.namespace||(i.args[1].bubbling=!0),"_reset"!==i.inputType&&t.handle.apply(t,i.args);break;case"handling":var n=i.ticket;n&&t.pendingDelegations[n]&&delete t.pendingDelegations[n],t.emit(e,i);break;default:t.emit(e,i)}})}function o(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}function c(t){e.extend(this,t),e.defaults(this,i()),this.initialize.apply(this,arguments),k.emit(m,this)}var u=[].slice,l="transition",h="handling",p="handled",f="nohandler",d="transition",y="invalidstate",g="deferred",m="newfsm",v=["states","initialState"],b=function(t,i){var n,s=this,a={},r=function(){};return n=t&&t.hasOwnProperty("constructor")?t.constructor:function(){var t=u.call(arguments,0);t[0]=t[0]||{};var i,n=t[0].states||{};i=e.merge(e.cloneDeep(a),{states:n}),i.initialState=t[0].initialState||this.initialState,e.extend(t[0],i),s.apply(this,t)},e.merge(n,s),r.prototype=s.prototype,n.prototype=new r,t&&(e.extend(n.prototype,t),e.merge(a,e.transform(t,function(t,e,i){v.indexOf(i)!==-1&&(t[i]=e)}))),i&&e.merge(n,i),n.prototype.constructor=n,n.__super__=s.prototype,n},S={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),listenToChild:r,getLeaklessArgs:s,getDefaultOptions:i,getDefaultClientMeta:n,createUUID:o},_={emit:function(t){var i=s(arguments);this.eventListeners["*"]&&e.each(this.eventListeners["*"],function(t){if(this.useSafeEmit)try{t.apply(this,i)}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,i)},this),this.eventListeners[t]&&e.each(this.eventListeners[t],function(t){if(this.useSafeEmit)try{t.apply(this,i.slice(1))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,i.slice(1))},this)},on:function(t,e){var i=this;return i.eventListeners=i.eventListeners||{"*":[]},i.eventListeners[t]||(i.eventListeners[t]=[]),i.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){i.off(t,e)}}},off:function(t,i){this.eventListeners=this.eventListeners||{"*":[]},t?i?this.eventListeners[t]=e.without(this.eventListeners[t],i):this.eventListeners[t]=[]:this.eventListeners={}}},A="__machina__";e.extend(c.prototype,{initialize:function(){},initClient:function(t){var e=this.initialState;if(!e)throw new Error("You must specify an initial state for this FSM");if(!this.states[e])throw new Error("The initial state specified does not exist in the states object.");this.transition(t,e)},ensureClientMeta:function(t){if("object"!=typeof t)throw new Error("An FSM client must be an object.");return t[A]=t[A]||{},t[A][this.namespace]||(t[A][this.namespace]=e.cloneDeep(S.getDefaultClientMeta()),this.initClient(t)),t[A][this.namespace]},buildEventPayload:function(t,i){return e.isPlainObject(i)?e.extend(i,{client:t,namespace:this.namespace}):{client:t,data:i||null,namespace:this.namespace}},getHandlerArgs:function(t,e){var i=t.slice(0),n=i[1];return"object"==typeof n&&i.splice(1,1,n.inputType),e?i:[i[0]].concat(i.slice(2))},handle:function(t,i){var n=i;if("undefined"==typeof i)throw new Error("The input argument passed to the FSM's handle method is undefined. Did you forget to pass the input name?");"string"==typeof i&&(n={inputType:i,delegated:!1,ticket:void 0});var a=this.ensureClientMeta(t),r=s(arguments);"object"!=typeof i&&r.splice(1,1,n),a.currentActionArgs=r.slice(1);var o,c,u,l,d,y=a.state,g=this.states[y],m=!1;if(!a.inExitHandler)if(u=g._child&&g._child.instance,!u||this.pendingDelegations[n.ticket]||n.bubbling){n.ticket&&this.pendingDelegations[n.ticket]&&delete this.pendingDelegations[n.ticket],o=g[n.inputType]?n.inputType:"*",m="*"===o,c=g[o]||this[o]||this["*"],d=a.state+"."+o,a.currentAction=d;var v=this.buildEventPayload(t,{inputType:n.inputType,delegated:n.delegated,ticket:n.ticket});c?(this.emit(h,v),"function"==typeof c?l=c.apply(this,this.getHandlerArgs(r,m)):(l=c,this.transition(t,c)),this.emit(p,v)):this.emit(f,e.extend({args:r},v)),a.priorAction=a.currentAction,a.currentAction=""}else n.ticket=n.ticket||S.createUUID(),n.delegated=!0,this.pendingDelegations[n.ticket]={delegatedTo:u.namespace},l=u.handle.apply(u,r);return l},transition:function(t,e){var i,n=this.ensureClientMeta(t),s=n.state,r=this.states[s],o=this.states[e];if(!n.inExitHandler&&e!==s){if(o){o._child&&(o._child=a(o._child),i=o._child&&o._child.instance),r&&r._onExit&&(n.inExitHandler=!0,r._onExit.call(this,t),n.inExitHandler=!1),r&&r._child&&r._child.instance&&this.hierarchy[r._child.instance.namespace]&&this.hierarchy[r._child.instance.namespace].off(),n.targetReplayState=e,n.priorState=s,n.state=e,i&&(this.hierarchy[i.namespace]=S.listenToChild(this,i));var c=this.buildEventPayload(t,{fromState:n.priorState,action:n.currentAction,toState:e});return this.emit(d,c),o._onEnter&&o._onEnter.call(this,t),i&&i.handle(t,"_reset"),void(n.targetReplayState===e&&this.processQueue(t,l))}this.emit(y,this.buildEventPayload(t,{state:n.state,attemptedState:e}))}},deferUntilTransition:function(t,e){var i=this.ensureClientMeta(t);if(i.currentActionArgs){var n={type:l,untilState:e,args:i.currentActionArgs};i.inputQueue.push(n);var s=this.buildEventPayload(t,{state:i.state,queuedArgs:n});this.emit(g,s)}},deferAndTransition:function(t,e){this.deferUntilTransition(t,e),this.transition(t,e)},processQueue:function(t){var i=this.ensureClientMeta(t),n=function(t){return!t.untilState||t.untilState===i.state},s=e.filter(i.inputQueue,n);i.inputQueue=e.difference(i.inputQueue,s),e.each(s,function(e){this.handle.apply(this,[t].concat(e.args))},this)},clearQueue:function(t,i){var n=this.ensureClientMeta(t);if(i){var s=function(t){return!i||t.untilState!==i};n.inputQueue=e.filter(n.inputQueue,s)}else n.inputQueue=[]},compositeState:function(t){var e=this.ensureClientMeta(t),i=e.state,n=this.states[i]._child&&this.states[i]._child.instance;return n&&(i+="."+n.compositeState(t)),i}},_),c.extend=b;var E={constructor:function(){c.apply(this,arguments),this.ensureClientMeta()},initClient:function(){var t=this.initialState;if(!t)throw new Error("You must specify an initial state for this FSM");if(!this.states[t])throw new Error("The initial state specified does not exist in the states object.");this.transition(t)},ensureClientMeta:function(){return this._stamped||(this._stamped=!0,e.defaults(this,e.cloneDeep(n())),this.initClient()),this},ensureClientArg:function(t){var e=t;return"object"!=typeof e[0]||"inputType"in e[0]||e[0]===this?("object"!=typeof e[0]||"object"==typeof e[0]&&"inputType"in e[0])&&e.unshift(this):e.splice(0,1,this),e},getHandlerArgs:function(t,e){var i=t,n=i[1];return"object"==typeof inputType&&i.splice(1,1,n.inputType),e?i.slice(1):i.slice(2)},buildEventPayload:function(){var t=this.ensureClientArg(S.getLeaklessArgs(arguments)),i=t[1];return e.isPlainObject(i)?e.extend(i,{namespace:this.namespace}):{data:i||null,namespace:this.namespace}}};e.each(["handle","transition","deferUntilTransition","processQueue","clearQueue"],function(t){E[t]=function(){var e=this.ensureClientArg(S.getLeaklessArgs(arguments));return c.prototype[t].apply(this,e)}}),E=c.extend(E);var k=e.merge(_,{Fsm:E,BehavioralFsm:c,utils:S,eventListeners:{newFsm:[]}});t.exports=k});
//# sourceMappingURL=machina.js.map
