define("features/ws-adhoc",["exports","packages/4game-api-client"],function(exports,e){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function t(e){if(e!=c){e>10&&(e=10);for(var n=e;n<c;++n)l[n].close();for(var n=c;n<e;++n){var t=u.connect(a);l[n]=t;t.on("/v3/app-statuses?size=50",function(e,t,r){console.log("hyper-facade-experiment-"+n.toString(),r,t,e)})}c=e,console.log("Connection count:"+c.toString())}}function r(){$.ajax("https://cdn.inn.ru/client.cfg").done(function(e){try{var n=JSON.parse(e).wssConnections,r=localStorage.getItem("wssConnections");null!=r&&(n=r),t(n)}catch(o){console.log(o),t(0)}}).fail(function(e){console.log("FAILED",e),t(0)})}var o=n(e),s=o["default"].getRulesForResource("get","auth"),a=(s.baseUrl,"wss://wss.4game.com/v3/"),i=function(){var e=0,n=function(){return e+=1,e.toString(16)};return{nextMessageId:n}}(),u=function(){var e={retryTimeout:3e4,pingInterval:45e3},n=function(n,t,r){var o=e;if(r)for(var s in r)o[s]=r[s];r=o;var a=r.retryTimeout,u=null,c=null,l={},f=function m(e){t&&m(e)},d=function(){1==u.readyState&&u.send(JSON.stringify({uri:"/meta/ping",method:"ping",headers:{"Hyperbus-Message-Id":[i.nextMessageId()]}}))},g=function(e){if(1==u.readyState){var n=l[e];u.send(JSON.stringify({uri:n.uri,method:"subscribe",headers:{"Hyperbus-Message-Id":[e]}}))}},y=function(e,n){if(e.headers&&e.headers[n]){var t=e.headers[n];if(t.length>0)return t[0]}return null},v=function h(){u=new WebSocket(n),u.onopen=function(){a=0,c=setInterval(d,r.pingInterval);for(var e in l)g(e);f({readyState:u.readyState,millisecondsUntilRetry:a})},u.onerror=function(e){Bugsnag.notify("Hyperbus-WS-Error","onerror: "+e.toString()),console.log("Hyperbus-WS-Error",e)},u.onclose=function(e){a>=0&&setTimeout(h,a);var n=a;a=r.retryTimeout,clearInterval(c),f({readyState:u.readyState,millisecondsUntilRetry:n}),e&&1e3!=e.code&&(Bugsnag.notify("Hyperbus-WS-Closed","Code: "+e.code.toString()),console.log("Hyperbus-WS-Close",e))},u.onmessage=function(e){var n=JSON.parse(e.data),t=null;t=n.uri?"event":"state";var r=y(n,"Content-Type"),o=y(n,"Hyperbus-Correlation-Id"),s=l[o];if(s){var a=null;n.body&&(a=n.body),s.callback(a,r,t)}"state"==t&&n.body.status>399&&Bugsnag.notify("Hyperbus-WS-Result","Status: "+n.body.status.toString())}},S=function(){a=-1,u.close()},p=function(e,n,t){var r=i.nextMessageId();return l[r]={uri:e,callback:n,criteria:t},g(r),r},b=function(e){l[e]&&(delete l[e],1==u.readyState&&u.send(JSON.stringify({uri:"/meta/unsubscribe",method:"unsubscribe",headers:{"Hyperbus-Message-Id":[e]}})))};return v(),{close:S,on:p,off:b}};return{connect:n}}(),c=0,l=[];r(),setInterval(r,6e5)});
//# sourceMappingURL=ws-adhoc.js.map
