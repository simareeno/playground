(function(){define(["packages/jquery","packages/che","packages/event-bus"],function(e,t,r){var n;return n=/\/play\/?$/i,{domEvents:{"submit .bPremiumRates__eForm":"onSubmit"},init:function(t){return this.document=e(document),this.container=e(t),this.eventNamespace="premium_rates",this.isRenewal=!1,this.oldDaysLeft=0,this.l4gModel=null,this.couponId=null,this.serviceId=this.container.data("service-id"),this.errorContainer=this.container.find(".bPremiumRates__eError"),this.errorMessage=this.errorContainer.find(".bPremiumRates__eErrorMessage"),this.document.one("l4g-model-ready."+this.eventNamespace,function(e){return function(t,r){return e.l4gModel=r.model}}(this)).trigger("get-l4g-model-status")},turnOn:function(){return this.checkCouponActions(),r.on("@premium-coupons","update",this.checkCouponActions,this)},turnOff:function(){return r.off("@premium-coupons","update",this.checkCouponActions,this)},checkCouponActions:function(){return this.container.find("input[name='SubscribeForm[couponId]']").each(function(t,r){var n,o,i,s,a,u,c,l,m;if(o=r.value,n=window.localStorage.getItem("action-premium-couponid-"+o),null!=n)return c=e(r).closest(".bTickets__eTicket"),m=c.closest(".bTickets"),l=c.index()+1,a=c.find("input[name='SubscribeForm[price]']"),s=a[0].value,u=a.data("coupon-promo-price"),i=a.data("coupon-months"),a[0].value=u,c.find("#premium-monthly-price-total-"+l).html(u),u<s&&c.find("#premium-monthly-price-old-"+l).html(s).show(),m.find("#premium-monthly-price-month-"+l).html(u/i)})},remove:function(){return this.document=this.container=this.l4gModel=this.serviceId=this.errorContainer=this.errorMessage=null},onSubmit:function(t,n){var o,i,s,a,u,c;for(t.preventDefault(),o=e(n),i=o.serializeArray(),c=n["SubscribeForm[serviceAccountIds][]"].value,a=0,u=i.length;a<u;a++)if(s=i[a],"SubscribeForm[couponId]"===s.name){this.couponId=s.value;break}return e.ajax({type:"POST",url:o.prop("action"),data:i,success:function(e){return function(t){var n;return e.oldDaysLeft=null!=(n=e.l4gModel)?n.get("Game/current.account.subscription.finishTime.daysLeft"):void 0,e.isRenewal=null!=e.oldDaysLeft,e.oldDaysLeft||(e.oldDaysLeft=0),t.result&&1===t.data[c].success?(r.trigger("@premium","purchased",{serviceId:e.serviceId}),e.reloadPage()):(o.find(".jsUIButton").trigger("progress-stop"),e.showError(e.getMessage(t.data[c])))}}(this),error:function(e){return function(t){return e.resolveError(t)}}(this)})},resolveError:function(e){switch(e.status){case 402:return this.setReturnCookie(),window.location=e.getResponseHeader("Location");default:return this.showError("Server error")}},showError:function(e){return this.errorContainer.addClass("bPremiumRates__eError__mState_active"),this.errorMessage.text(e)},hideError:function(){return this.errorContainer.removeClass("bPremiumRates__eError__mState_active")},setReturnCookie:function(t){var r;return null==t&&(t=.5),r=window.location.pathname+window.location.search,e.cookie("inn-payment-redirect",""+r+(r.search(/\?/)===-1?"?":"&")+"activeCoupon="+this.couponId,{expires:new Date(+new Date+60*t*60*1e3),path:"/"})},reloadPage:function(){var e,t,r;t=!n.test(window.location.pathname),e="/"+(null!=(r=this.l4gModel)?r.get("GameData/services."+this.serviceId+".key"):void 0)+"/play/",window.location.href=e},getMessage:function(e){return null!=e?"object"==typeof e.message?e.message.message:e.message:"Unknown error"}}})}).call(this);
//# sourceMappingURL=bPremiumRates.js.map
