define(["exports","jade_templates","i18n_t","packages/jquery","block!purchase/tools","block!purchase/lib/machina","block!purchase/purchase-agent","block!purchase/flow-client"],function(exports,E,t,n,R,D,e,S){"use strict";function T(E,t,n){return t in E?Object.defineProperty(E,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):E[t]=n,E}function I(){function n(){var E=this;Q.on("click",function(t){return V.onClick?void V.onClick(t):void E.handle(i.CLICK_REQUESTED)}),U(r.INITIALIZING),this.transition(r.READY_FOR_INTERACTION)}function I(){U(r.READY_FOR_INTERACTION)}function o(){U(r.BLOCKED)}function O(){U(r.DISABLED)}function u(){U(r.HIDDEN)}function a(){var E=void 0;try{if(E=v.product.offer.prices,!E.length)return void this.handle(i.RESOLVE_REQUESTED);this.handle(i.BLOCKING_REQUESTED)}catch(t){return void this.handle(i.RESOLVE_REQUESTED)}var n=E[0],R=B.getAttribute("data-voucher-ids")||"";H.emit(S.EVENTS.PRODUCT_PURCHASE_REQUESTED,{productId:B.getAttribute("data-product-id"),promoId:B.getAttribute("data-promo-id"),voucherIds:R.split(",").filter(Boolean),price:n.price,quantity:n.quantity,currency:n.currency,element:B})}function c(){var E=this.currentActionArgs[1]||[];_(v,B,E),this.handle(i.RESOLVE_REQUESTED)}function C(){var E=this.currentActionArgs[1]||[];_(v,B,E.products),this.handle(i.RESOLVE_REQUESTED)}function A(){null===v.product&&console.warn('Product info not found in "resolveNextState"');var E=G.canPurchase?G.canPurchase(v.product):v.product&&!!v.product.offer.prices.length;E?this.handle(i.READY_REQUESTED):this.handle(i.DISABLE_REQUESTED)}function U(E){null!==G.render&&(G.render||N)(E)}function N(n){var R=G.template||E.PurchaseButton;G.container.innerHTML=R({i18n_t:t,data:{title:G.title||B.getAttribute("data-title")||"Купить",loading:r.BLOCKED===n,disabled:r.DISABLED===n,hidden:r.HIDDEN===n}})}var L,d,P,l,s,h,f,G=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],B=G.container,Q=new R.EventBus(B),H=G.eventBus||new R.EventBus(document),p=R.noop;G.debug&&(p=R.initializeFSM(G.debugTitle||"FSM "+B.id));var v={product:null},g=new D.Fsm({initialize:p,initialState:r.INITIALIZING,states:(f={},T(f,r.INITIALIZING,T({},i.INITIALIZED,n)),T(f,r.READY_FOR_INTERACTION,(L={_onEnter:I},T(L,i.BLOCKING_REQUESTED,r.BLOCKED),T(L,i.DISABLING_REQUESTED,r.DISABLED),T(L,i.CLICK_REQUESTED,r.CLICK_PROCESSING),L)),T(f,r.CLICK_PROCESSING,(d={_onEnter:a},T(d,i.BLOCKING_REQUESTED,r.BLOCKED),T(d,i.RESOLVE_REQUESTED,r.NEXT_STATE_RESOLVING),d)),T(f,r.PRODUCTS_UPDATING,T({_onEnter:c},i.RESOLVE_REQUESTED,r.NEXT_STATE_RESOLVING)),T(f,r.PURCHASE_RESULT_PROCESSING,T({_onEnter:C},i.RESOLVE_REQUESTED,r.NEXT_STATE_RESOLVING)),T(f,r.BLOCKED,(P={_onEnter:o},T(P,i.PRODUCTS_LOADED,r.PRODUCTS_UPDATING),T(P,i.PRODUCT_PURCHASED,r.PURCHASE_RESULT_PROCESSING),T(P,i.HIDE_REQUESTED,r.HIDDEN),T(P,i.ERROR_THROWED,r.NEXT_STATE_RESOLVING),P)),T(f,r.DISABLED,(l={_onEnter:O},T(l,i.PRODUCTS_LOADED,r.PRODUCTS_UPDATING),T(l,i.PRODUCT_PURCHASED,r.PURCHASE_RESULT_PROCESSING),T(l,i.HIDE_REQUESTED,r.HIDDEN),T(l,i.ERROR_THROWED,r.NEXT_STATE_RESOLVING),l)),T(f,r.HIDDEN,(s={_onEnter:u},T(s,i.PRODUCTS_LOADED,r.PRODUCTS_UPDATING),T(s,i.PRODUCT_PURCHASED,r.PURCHASE_RESULT_PROCESSING),T(s,i.ERROR_THROWED,r.NEXT_STATE_RESOLVING),s)),T(f,r.NEXT_STATE_RESOLVING,(h={_onEnter:A},T(h,i.READY_REQUESTED,r.READY_FOR_INTERACTION),T(h,i.DISABLE_REQUESTED,r.DISABLED),h)),f),run:function(){return this.handle(i.INITIALIZED),this}}),K={initialize:function(){g.run()},onProductsLoadingStarted:function(){g.handle(i.BLOCKING_REQUESTED)},onProductsLoaded:function(E,t){null===E?g.handle(i.PRODUCTS_LOADED,t.detail):g.handle(i.ERROR_THROWED,E)},onProductPurchasingStarted:function(){g.handle(i.BLOCKING_REQUESTED)},onProductPurchased:function(E,t){null===E?g.handle(i.PRODUCT_PURCHASED,t.detail):g.handle(i.ERROR_THROWED,E)}},V=R.assign({getProductInfo:R.getProductInfo},K,G,{fsm:g,base:K});return new e.PurchaseAgent(V),{fsm:g,rootBus:H,buttonBus:Q}}function _(E,t,n){var D=R.getProductInfo(t,n);return D&&(E.product=D),E}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PurchaseButton=I;var r={INITIALIZING:"INITIALIZING",READY_FOR_INTERACTION:"READY_FOR_INTERACTION",CLICK_PROCESSING:"CLICK_PROCESSING",PRODUCTS_UPDATING:"PRODUCTS_UPDATING",BLOCKED:"BLOCKED",DISABLED:"DISABLED",HIDDEN:"HIDDEN",NEXT_STATE_RESOLVING:"NEXT_STATE_RESOLVING",PURCHASE_RESULT_PROCESSING:"PURCHASE_RESULT_PROCESSING",ERROR_PROCESSING:"ERROR_PROCESSING"};exports.STATES=r;var i={INITIALIZED:"INITIALIZED",CLICK_REQUESTED:"CLICK_REQUESTED",BLOCKING_REQUESTED:"BLOCKING_REQUESTED",DISABLE_REQUESTED:"DISABLE_REQUESTED",HIDE_REQUESTED:"HIDE_REQUESTED",READY_REQUESTED:"READY_REQUESTED",PRODUCTS_LOADED:"PRODUCTS_LOADED",PRODUCTS_UPDATED:"PRODUCTS_UPDATED",PRODUCT_PURCHASED:"PRODUCT_PURCHASED",RESOLVE_REQUESTED:"RESOLVE_REQUESTED",ERROR_THROWED:"ERROR_THROWED"};exports.EVENTS=i});
//# sourceMappingURL=PurchaseButton.js.map
