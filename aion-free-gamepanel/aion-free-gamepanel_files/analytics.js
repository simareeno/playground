define(["exports","packages/che","packages/jquery","packages/bacon","packages/4game-api-client","features/featuring","streams/events","block!purchase/flow-client","./analytics/app"],function(exports,e,t,n,a,r,o,i,u){"use strict";function l(e){return e&&e.__esModule?e:{"default":e}}function d(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function c(e,t,n){return k.then(function(a){return a&&(t=E["default"].extend({ab:a},t)),h["default"].track(e,t,n)})}function f(){return T?Date.now()-T:0}function p(e,t){var n="EUNHANDLED";switch(e){case 1:(0,i.isErrorMatched)(t,i.ERROR_MESSAGES.NOT_ENOUGH_FUNDS)&&(n="ENOTSUFFICIENTFUNDS"),(0,i.isErrorMatched)(t,i.ERROR_MESSAGES.FIO_REQUIRED)&&(n="EFIOREQUIRED"),t.status===i.ERRORS.Unauthorized&&(n="ENOTAUTHORIZED");break;case 2:"Precondition Failed"===t.code?(~t.message.indexOf(i.ERROR_MESSAGES.NOT_ENOUGH_FUNDS)&&(n="ENOTSUFFICIENTFUNDS"),~t.message.indexOf(i.ERROR_MESSAGES.FIO_REQUIRED)&&(n="EFIOREQUIRED")):"ENOFUNDS"===t.code&&(n="ENOTSUFFICIENTFUNDS"),"EUNAUTHORIZED"!==t.code&&t.statusCode!==i.ERRORS.Unauthorized||(n="ENOTAUTHORIZED")}return n}function s(e){var t=e.error,n=e.isError,a=e.products,r=e.voucherIds,o=e.version;a=a.map(function(e){var t=e.appId,n=e.productId;return{appId:t,productId:n,voucherIds:r}}),a.forEach(v("purchase-requested")),n?a.forEach(v("purchase-failed",{errorCode:p(o,t)})):a.forEach(v("purchase-succeeded"))}function v(e,t){return function(n){return I["default"].track(e,E["default"].extend({},n,t))}}var m=function(){function e(e,t){var n=[],a=!0,r=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(a=(i=u.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(l){r=!0,o=l}finally{try{!a&&u["return"]&&u["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),y=l(e),E=l(t),g=l(n),h=l(a),I=l(o);(0,u.trackGamepanelEvents)(I["default"].log.bind(null,"@gamepanel","interaction"));var w=document.createElement("a"),S=["authorization-failed","authorization-started","authorization-timeouted","authorization-succeeded"],O=["install-game-clicked","download-branded-installer-clicked"],R={"user-does-not-have-l4g-app":"no-l4g-app-detected","plugin-failed-to-connect":"plugin-connection-failed","extension-failed-to-connect":"extension-connection-failed","ws-failed-to-connect-first-round":"ws-connection-failed-once","ws-failed-to-connect-second-round":"ws-connection-failed-twice"},A={"bns-ya-ab":{handler:function(e){if(e)return{code:"yandex-bns-free-preorder",variant:e}}}},N=Object.keys(A).map(function(e){return E["default"].extend({id:e},A[e])}).sort(function(e,t){var n=e.priority,a=void 0===n?0:n,r=t.priority,o=void 0===r?0:r;return o-a}),U=N.map(function(e){var t=e.id,n=e.handler;return(0,r.check)(t).then(n)}).map(function(e){return(0,r.jquerify)(E["default"],e)}).map(function(e){return e.then(null,function(){return E["default"].Deferred().resolve(!1)})}),k=E["default"].when.apply(E["default"],d(U)).then(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.filter(Boolean)[0]}),D=void 0,T=!1;g["default"].fromEvent(document,i.EVENTS.PRODUCT_PURCHASED).map(".detail").filter(function(e){var t=e.error,n=e.isError;return!t||n}).map(function(e){var t=e.productInfo,n=e.products,a=e.error,r=e.isError,o=t.productId,i=t.voucherIds,u=n.reduce(function(e,t){return t.productId===o?t:e},null);if(u){var l=u.appId;return{error:a,isError:r,products:[{appId:l,productId:o}],voucherIds:i,version:1}}}).filter(Boolean).onValue(s),g["default"].fromEvent(document,"purchaseComplete").merge(g["default"].fromEvent(document,"purchaseFailed")).map(function(e){var t=e.detail instanceof Error,n=t?e.detail:null,a=t?n.payload:e.detail.data,r=a.orderedProducts,o=a.voucherIds;return{error:n,isError:t,products:r,voucherIds:o,version:2}}).onValue(s),I["default"].getAll().filter(I["default"].filter.envelope("gamepanel","interaction")).map(".payload").onValue(function(e){var t=m(e,2),n=t[0],a=t[1];c(n,a)}),I["default"].getAll().filter(function(e){var t=e.channel,n=e.name;return"user"===t&&~S.indexOf(n)}).onValue(function(e){e.evaluate(function(e,t){c(e,t)})}),I["default"].getAll().filter(I["default"].filter.envelope("user","interaction")).map(".payload").onValue(function(e){var t=m(e,3),n=t[0],a=t[1],r=t[2];"navigation"===n&&(n="user-navigated",a={href:a,che:!1},r&&E["default"].extend(a,r,{sections:"omitted"})),"license-accepted"===n&&2===a.licenceType&&(n="mmo-agreement-confirmed",a={appId:a.serviceId,appName:a.data.key}),~O.indexOf(n)&&(a={appId:a.serviceId,appName:a.data.key,desktopAppConnected:"install-game-clicked"===n},n="mmo-install-clicked"),c(n,a)}),I["default"].getAll().filter(I["default"].filter.envelope("user","payment")).map(".payload").filter(function(e){var t=m(e,1),n=t[0];return"payment-widget-pay-button-pressed"!==n}).onValue(function(e){var t=m(e,2),n=t[0],a=t[1];if("payment-widget-gateway-selected"===n){var r=a,o=r.paymentName,i=r.paymentView;a={},D||(n="payment-widget-default-gateway-selected"),D=o;var u=A[D]||{},l=u.code,d=(u.variants||{})[i];l&&d&&(a.ab={code:l,variant:d})}c(n,E["default"].extend({paymentGateway:D,widgetSpentTime:f()},a))}),I["default"].getAll().filter(I["default"].filter.envelope("user","payment")).map(".payload").filter(function(e){var t=m(e,1),n=t[0];return"payment-widget-pay-button-pressed"===n}).onValue(function(e){var t=m(e,2),n=t[0],a=t[1],r={paymentGateway:D,widgetSpentTime:f()};c(n,r,{forced:!0}).then(a.next)}),I["default"].getAll().filter(I["default"].filter.envelope("user","interaction")).map(".payload").filter(function(e){var t=m(e,1),n=t[0];return"navigation"===n}).onValue(function(e){var t=m(e,3),n=t[1],a=(t[2],void 0);w.href=n,a=!!~w.search.indexOf("popupWidget=PaymentTerminalWidget"),!T&&a&&(T=Date.now(),I["default"].log("@user","payment","payment-widget-opened")),T&&!a&&(D=null,I["default"].log("@user","payment","payment-widget-closed",{paymentGateway:D,widgetSpentTime:f()}),T=!1)}),I["default"].getAll().filter(I["default"].filter.envelope("l4g-application","info")).map(function(e){var t=m(e.payload,1),n=t[0];return R[n]}).filter(Boolean).assign(c),I["default"].getAll().filter(I["default"].filter.envelope("l4g-application","tracks")).map(function(e){var t=m(e.payload,1),n=t[0];return n}).filter(Boolean).flatMap(g["default"].fromArray).assign(c),I["default"].getAll().filter(I["default"].filter.envelope("license","accepted")).onValue(function(e){var t=m(e.payload,1),n=t[0];I["default"].track("license-accepted",n)});var b=g["default"].fromBinder(function(e){var t=["history:popState","history:pushState","history:replaceState"].join(" "),n=function(t){return e([window.location.href,t])};return e([window.location.href]),y["default"].events.bind(t,n),function(){return y["default"].events.unbind(t,n)}});b.skipDuplicates(function(e,t){var n=m(e,1),a=n[0],r=m(t,1),o=r[0];return a===o}).onValue(function(e){return I["default"].track.apply(I["default"],["navigation"].concat(d(e)))})});
//# sourceMappingURL=analytics.js.map
