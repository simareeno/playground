define(["exports","packages/4game-api-client","packages/es6-promise","block!purchase/lib/machina","block!purchase/tools"],function(exports,r,n,t,e){"use strict";function o(r,n,t){return n in r?Object.defineProperty(r,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[n]=t,r}function u(r){function n(r){return function(){var n=this.currentActionArgs[1];f.emit(r,n)}}function u(){f.emit(a.PRODUCTS_LOADING_STARTED);var r=T=_().then(function(n){r===T&&(d.products=n,N.handle(a.PRODUCTS_LOADED,n))},function(n){r===T&&N.handle(a.ERROR_THROWED,{error:n})})}function R(){function n(n){return O.post(s.createOrder,{orderedProducts:[{appId:r.appId,productId:I.productId,quantity:I.quantity,price:I.price,currency:I.currency}],voucherIds:n}).then(function(r){return[n,r]},E())}function t(r){var n=i(r,2),t=n[0],e=n[1];return O.put(s.purchaseOrder(e.orderId),{voucherIds:t}).then(function(){return e},E({orderInfo:e}))}function o(r){return _().then(function(n){return[n,r]},E({orderInfo:r}))}function u(r){var n=i(r,2),t=n[0],e=n[1];N.handle(a.PRODUCT_PURCHASED,{orderInfo:e,products:t,productInfo:I})}function R(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return r.isProcessed?r:{error:r,isProcessed:!0}}function E(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return function(n){return c.reject(e.assign(R(n),r))}}function D(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return r.isProcessed||(r={error:r,isProcessed:!0}),_().then(function(r){return d.products=r},function(){return d.products}).then(function(n){var t=e.assign(r,{products:n,productInfo:I});return N.handle(a.ERROR_THROWED,t),c.reject(t)})}var I=this.currentActionArgs[1]||{};f.emit(a.PRODUCT_PURCHASING_STARTED),S(I).then(n).then(t).then(o).then(u)["catch"](D)}function E(){var r,n=this.priorState,t=e.assign({},this.currentActionArgs[1],{state:n,isError:!0});console.error('Error in state "'+n+'" :: ',t);var u=(r={},o(r,D.LOADING_PRODUCTS_INFO,a.PRODUCTS_LOADED),o(r,D.PURCHASING_PRODUCT,a.PRODUCT_PURCHASED),r),R=u[n];f.emit(R,t),this.handle(a.ERROR_PROCESSED)}function I(){function r(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=r.products.map(function(n){return S(n).then(function(t){var e=s.getProduct(r.appId,n.productId);return O.get(e,{voucherId:t&&t[0]})})});return c.all(n)}function n(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return O.get(s.getProducts(r.appId)).then(function(r){return r.products||[]})}var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e={ONE_REQUEST:n,MANY_REQUESTS:r};return new c(function(r,n){e[t.loadStrategy](t).then(r,n)})}function _(){return I({products:r.getProductDescriptors?r.getProductDescriptors():[],loadStrategy:r.loadStrategy,appId:r.appId,promoId:r.promoId})}function S(){var r=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return new c(function(n,t){var e=(r.voucherIds||[]).filter(Boolean);e.length?n(e):r.promoId?O.get(s.getVouchers(),{promoId:r.promoId}).then(function(r){n((r.vouchers||[]).map(function(r){return r.voucherId}))},t):n([])})}var P,A,C,U,f=new e.EventBus(r.container||document),p=e.noop;r.debug&&(p=e.initializeFSM(r.debugTitle||"FlowClient FSM"));var N=new t.Fsm({initialize:p,initialState:D.INITIALIZING,states:(U={},o(U,D.INITIALIZING,{_onEnter:function(){var r=this;f.on(a.PRODUCTS_INFO_REQUESTED,function(){return r.handle(a.PRODUCTS_INFO_REQUESTED)}),f.on(a.PRODUCT_PURCHASE_REQUESTED,function(n){var t=n.detail;return r.handle(a.PRODUCT_PURCHASE_REQUESTED,t)}),this.transition(D.READY_FOR_INTERACTION)}}),o(U,D.READY_FOR_INTERACTION,(P={},o(P,a.PRODUCTS_INFO_REQUESTED,D.LOADING_PRODUCTS_INFO),o(P,a.PRODUCT_PURCHASE_REQUESTED,D.PURCHASING_PRODUCT),P)),o(U,D.LOADING_PRODUCTS_INFO,(A={_onEnter:u,_onExit:n(a.PRODUCTS_LOADED)},o(A,a.ERROR_THROWED,D.ERROR_PROCESSING),o(A,a.PRODUCTS_LOADED,D.READY_FOR_INTERACTION),o(A,a.PRODUCTS_INFO_REQUESTED,function(){f.emit(a.PRODUCTS_LOADING_ABORTED),u()}),A)),o(U,D.PURCHASING_PRODUCT,(C={_onEnter:R,_onExit:n(a.PRODUCT_PURCHASED)},o(C,a.ERROR_THROWED,D.ERROR_PROCESSING),o(C,a.PRODUCT_PURCHASED,D.READY_FOR_INTERACTION),C)),o(U,D.ERROR_PROCESSING,o({_onEnter:E},a.ERROR_PROCESSED,D.READY_FOR_INTERACTION)),U),run:function(){return this.handle(a.INITIALIZED),this}});return N.run()}function R(r,n){if(!r||!n)return!1;var t;try{t=r.responseJSON.message}catch(e){t=""}return t.indexOf(n)>-1}Object.defineProperty(exports,"__esModule",{value:!0});var i=function(){function r(r,n){var t=[],e=!0,o=!1,u=void 0;try{for(var R,i=r[Symbol.iterator]();!(e=(R=i.next()).done)&&(t.push(R.value),!n||t.length!==n);e=!0);}catch(c){o=!0,u=c}finally{try{!e&&i["return"]&&i["return"]()}finally{if(o)throw u}}return t}return function(n,t){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return r(n,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();exports.FlowClient=u,exports.isErrorMatched=R;var c=window.Promise||n.Promise,E=r.use({rules:{"get users/+/apps/+/products":{letAnonymous:!0},"get users/+/apps/+/products/+":{letAnonymous:!0},"get users/+/vouchers":{letAnonymous:!0}}}),O=E.use({send:function(){for(var r,n=arguments.length,t=Array(n),o=0;o<n;o++)t[o]=arguments[o];return e.promisifyJq((r=E.send).call.apply(r,[E].concat(t)))}}),s={getProducts:function(r){return"users/#{userId}/apps/"+r+"/products"},getProduct:function(r,n){return"users/#{userId}/apps/"+r+"/products/"+n},getVouchers:function(){return"users/#{userId}/vouchers"},createOrder:"users/#{userId}/orders",purchaseOrder:function(r){var n=Date.now();return"users/#{userId}/orders/"+r+"/purchases/"+n}},a={INITIALIZED:"INITIALIZED",PRODUCTS_INFO_REQUESTED:"PRODUCTS_INFO_REQUESTED",PRODUCTS_LOADING_STARTED:"PRODUCTS_LOADING_STARTED",PRODUCTS_LOADING_ABORTED:"PRODUCTS_LOADING_ABORTED",PRODUCTS_LOADED:"PRODUCTS_LOADED",PRODUCT_PURCHASE_REQUESTED:"PRODUCT_PURCHASE_REQUESTED",PRODUCT_PURCHASING_STARTED:"PRODUCT_PURCHASING_STARTED",PRODUCT_PURCHASED:"PRODUCT_PURCHASED",ERROR_THROWED:"ERROR_THROWED",ERROR_PROCESSED:"ERROR_PROCESSED"};exports.EVENTS=a;var D={INITIALIZING:"INITIALIZING",LOADING_PRODUCTS_INFO:"LOADING_PRODUCTS_INFO",CREATING_ORDER:"CREATING_ORDER",PURCHASING_PRODUCT:"PURCHASING_PRODUCT",READY_FOR_INTERACTION:"READY_FOR_INTERACTION",ERROR_PROCESSING:"ERROR_PROCESSING"},I={Unauthorized:401,Conflict:409,PreconditionFailed:412};exports.ERRORS=I;var _={FIO_REQUIRED:"User name required for purchase",NOT_ENOUGH_FUNDS:"Not enough funds"};exports.ERROR_MESSAGES=_;var d={products:null},T=void 0});
//# sourceMappingURL=flow-client.js.map
